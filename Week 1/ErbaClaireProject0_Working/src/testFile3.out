dmlog'clear';
optionsmprintmlogicsymbolgenerrors=5compress=yesspool;
%letpath=X:\Antitrust\ROLLINSACQ(113373)\SAS\CE;
%letinput=&path.\input;
%letraw=&path.\raw;
%letexport=&path.\output;
%letlookups=&path.\lookups;
procimportdatafile="&input.\2016_households_by_zip_income.xlsx"out=households_by_zip_income_16dbms=xlsxreplace;run;
procimportdatafile="&input.\2017_households_by_zip_income.xlsx"out=households_by_zip_income_17dbms=xlsxreplace;run;
%letstates=ALAKAZARCACOCTDEDCFLGAHIIDILINIAKSKYLAMEMDMAMIMNMSMOMTNENVNHNJNMNYNCNDOHOKORPARISCSDTNTXUTVTVAWAWVWIWY;
%macroimport_bus(states);
%letn=%sysfunc(countw(&states));
%doi=1%to&n;
%letval=%scan(&states,&i);
procimportdatafile="&raw.\businessdata\AK\BP_2016_00CZ2_with_ann.csv"out=AK_businessesdbms=csvreplace;run;
%end;
%mend;
%import_bus(&states);
procimportdatafile="&lookups.\uszipsv1.4.csv"out=zip_to_other_geo_lookupdbms=csvreplace;run;
datazip_to_other_geo_lookup;setzip_to_other_geo_lookup;
zip2=input(zip,8.);
dropzip;
renamezip2=zip;
run;
%macroclean_household_data(year,value);
proctransposedata=households_by_zip_income_&year(keep=Id2&value:)out=households_&year._&value.(rename=(COL1=&value._&year_NAME_=income_bandID2=zip)drop=_LABEL_);
byId2;
run;
datahouseholds_&year._&value.;sethouseholds_&year._&value.;
labelincome_band=income_bandId2=zip;
ifincome_band="households_total"thendelete;
income_band=tranwrd(income_band,"&value._","");
run;
procsqlnoprint;
createtablehouseholds_&year._&value.asselect*fromhouseholds_&year._&value.asa
leftjoinasb
ona.zip=b.and
a.income_band=b.
quit;
datahouseholds_&year._&value.;sethouseholds_&year._&value.;
&value._&year=&value._&year*;
drop;
run;
procsortdata=households_&year._&value.;byzipincome_band;run;
%mend;
%clean_household_data(16,households);
%clean_household_data(16,margin);
%clean_household_data(17,households);
%clean_household_data(17,margin);
datahouseholds_cleaned_dataset;
mergehouseholds_16_householdshouseholds_16_marginhouseholds_17_householdshouseholds_17_margin;
byzipincome_band;
run;
databusinesses_cleaned_dataset;setbusinesses_by_zip_sector_16;
renameId2=zipMeaning_of_2012_NAICS_code=sector;
labelzip=zipsector=sector;
ifsector="Totalforallsectors"thendelete;
ifMeaning_of_Employment_size_of_es^="Allestablishments"thendelete;
run;
procmeansdata=businesses_cleaned_datasetnwaymissingnoprint;
classzipsector;
outputout=businesses_cleaned_dataset(drop=_TYPE__FREQ_)sum(Number_of_establishments)=;
run;
procsqlnoprint;
createtablebusinesses_cleaned_datasetasselect*frombusinesses_cleaned_datasetasa
leftjoinasb
ona.Id2=b.
a.Meaning_of_2012_NAICS_code=b.;
quit;
/*calculatecommercialmarketsharebyoberlappingzipsforagivensectorandyear